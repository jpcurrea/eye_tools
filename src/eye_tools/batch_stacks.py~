#!/usr/bin/env python

"""Batch process all folders of images stacks and save focus stack.


Assumes the following folder structure of stacks of .jpg images:

.\
|--batch_process_stacks.py
|--stack_1\
   |--img_001.jpg
   |--img_002.jpg
   |...
|--stack_1.png (outcome)
|--stack_2\
   |--img_001.jpg
   |--img_002.jpg
   |...
|--stack_2.png (outcome)
|--_hidden_folder\
   |(skipped files)
   |...
...
"""
import os
from scipy import misc
from analysis_tools import *

# load filenames and folders
fns = os.listdir(os.getcwd())
img_fns = [fn for fn in fns if fn.endswith(".jpg")]
folders = [fn for fn in fns if os.path.isdir(fn)]
folders = [os.path.join(os.getcwd(), f) for f in folders]
# for each folder
for f in folders:
    # skip hidden folders
    if not f.startswith("_"):
        print(f)
        breakpoint()
        fly = os.path.dirname(f)  # get stack name
        flyname = "{}.jpg".format(fly)
        st = Stack(f, f_type=".TIF")
        st.load()
        st.get_focus_stack()
        if st.stack is not None:
            plt.imsave(os.path.join(f, "stack.jpg"), st.stack.astype('uint8'))
            plt.imsave(flyname, st.stack.astype('uint8'))
            # misc.imsave(os.path.join(f, "focusStack2.jpg"), st.stack)
